# Отчет по безопасности проекта Equipment Tracker

**Дата анализа:** 23 ноября 2025  
**Версия проекта:** 1.0.18  
**Тип приложения:** Electron-based Desktop Application (Windows, macOS, Linux)

---

## Резюме

Проведен комплексный анализ безопасности приложения Equipment Tracker. Обнаружено **15 категорий уязвимостей** различной степени критичности. Приложение имеет несколько серьезных проблем безопасности, требующих немедленного внимания, особенно в области:

- Injection атак (SQL, Command Injection)
- Небезопасного обновления приложения
- Отсутствия аутентификации и авторизации
- Недостаточной валидации входных данных
- Небезопасной обработки внешних URL

---

## 1. КРИТИЧЕСКИЕ УЯЗВИМОСТИ (High Severity)

### 1.1 SQL Injection через поисковый функционал

**Расположение:** `electron/ipc/requests.ts:71`, `electron/ipc/employeeExits.ts:60`

**Описание:**  
Функции `applyRequestSearchFilter` и `applyExitSearchFilter` используют пользовательский ввод напрямую в SQL LIKE запросах. Хотя присутствует экранирование специальных символов `%` и `_`, это недостаточно для защиты от сложных SQL injection атак.

```typescript
// electron/ipc/requests.ts:71
const likeTerm = `%${term.replace(/[%_]/g, '\\$&')}%`
query.where((builder) => {
  builder.whereLike('employee_name', likeTerm).orWhereLike('login', likeTerm)
  // ...
})
```

**Проблемы:**

- Недостаточное экранирование может позволить инъекцию через специальные символы SQLite
- Использование `whereRaw` в `electron/ipc/requests.ts:81` с динамическими данными
- Отсутствие параметризованных запросов в критических местах

**Потенциальный вектор атаки:**

```javascript
// Злоумышленник может попытаться внедрить SQL код через поисковую строку
search: "test' OR 1=1--"
```

**Рекомендации:**

1. Использовать параметризованные запросы везде
2. Применять prepared statements через Knex
3. Добавить белый список разрешенных символов в поиске
4. Использовать `where` вместо `whereLike` где возможно

---

### 1.2 Command Injection в процессе обновления macOS

**Расположение:** `electron/updater.ts:36-60`

**Описание:**  
Функция `removeMacQuarantineAttribute` выполняет системную команду `xattr` с путем к файлу без достаточной валидации. Если путь к файлу содержит специальные символы или был скомпрометирован, это может привести к выполнению произвольных команд.

```typescript
// electron/updater.ts:43
execFile('xattr', ['-dr', 'com.apple.quarantine', filePath], (error) => {
  // ...
})
```

**Проблемы:**

- Путь к файлу (`filePath`) может содержать специальные символы
- Отсутствует валидация пути перед выполнением команды
- Используется в критическом процессе обновления приложения

**Потенциальный вектор атаки:**

- Манипуляция с путями загрузки обновлений
- Создание символических ссылок на критические системные файлы

**Рекомендации:**

1. Валидировать путь к файлу перед выполнением команды
2. Использовать `path.normalize()` и проверять, что путь находится в ожидаемой директории
3. Добавить белый список допустимых расширений файлов
4. Рассмотреть использование более безопасных альтернатив

---

### 1.3 Небезопасное открытие внешних URL без валидации

**Расположение:** `electron/window.ts:80`, `electron/updater.ts:295-296`

**Описание:**  
Функция `shell.openExternal` используется для открытия URL в браузере без должной валидации. Злоумышленник может использовать это для выполнения произвольных команд через протоколы типа `file://`, `javascript:`, или другие.

```typescript
// electron/window.ts:80
void shell.openExternal(`https://forge.tcsbank.ru/case/${sdNumber}/info`)
```

**Проблемы:**

- `sdNumber` берется из выделенного текста пользователя без полной валидации
- Отсутствует проверка на опасные протоколы (file://, javascript:, etc.)
- В updater.ts используется `shell.openPath` для открытия загруженных файлов

**Потенциальный вектор атаки:**

```javascript
// Пользователь может выделить текст содержащий:
'sd javascript:alert(document.cookie)'
// Или
'file:///etc/passwd'
```

**Рекомендации:**

1. Добавить строгую валидацию URL перед открытием
2. Разрешить только HTTPS протокол и конкретные домены
3. Использовать белый список разрешенных доменов
4. Валидировать формат номера SD перед построением URL

```typescript
// Пример безопасной валидации
function isValidSDNumber(sd: string): boolean {
  return /^\d{3,}$/.test(sd) && parseInt(sd) > 0
}

function isSafeUrl(url: string): boolean {
  try {
    const parsed = new URL(url)
    return parsed.protocol === 'https:' && parsed.hostname === 'forge.tcsbank.ru'
  } catch {
    return false
  }
}
```

---

### 1.4 Отсутствие аутентификации и авторизации

**Расположение:** Весь проект

**Описание:**  
Приложение не имеет механизмов аутентификации пользователей. Любой человек с физическим доступом к компьютеру может:

- Просматривать все данные об оборудовании и сотрудниках
- Изменять/удалять записи
- Экспортировать конфиденциальную информацию
- Получить доступ к резервным копиям базы данных

**Проблемы:**

- База данных SQLite хранится в открытом виде в `userData` директории
- Отсутствует шифрование базы данных
- Нет разграничения прав доступа
- Нет журналирования действий пользователей

**Потенциальный вектор атаки:**

- Физический доступ к компьютеру
- Копирование файла базы данных `equipment.db`
- Чтение конфиденциальных данных о сотрудниках

**Рекомендации:**

1. Внедрить систему аутентификации (локальный PIN/пароль)
2. Использовать шифрование базы данных (SQLCipher)
3. Добавить журналирование всех операций (audit log)
4. Реализовать роли пользователей (администратор/пользователь)
5. Автоматическая блокировка при неактивности

---

### 1.5 Небезопасное хранение данных

**Расположение:** `electron/database.ts`, директория `userData`

**Описание:**

- База данных SQLite хранится без шифрования в `userData/equipment.db`
- Резервные копии также не зашифрованы (`userData/backups/`)
- Конфиденциальные данные (ФИО сотрудников, логины, информация об оборудовании) доступны в открытом виде

```typescript
// electron/database.ts:33
function getDatabasePath(): string {
  return path.join(app.getPath('userData'), 'equipment.db')
}
```

**Проблемы:**

- Отсутствие шифрования at-rest
- Легкий доступ к файлу БД через файловую систему
- Резервные копии также уязвимы

**Рекомендации:**

1. Использовать SQLCipher для шифрования базы данных
2. Шифровать резервные копии
3. Использовать защищенное хранилище ОС для ключей (Keychain/Credential Manager)
4. Добавить опцию автоматического удаления старых резервных копий

---

## 2. УЯЗВИМОСТИ СРЕДНЕЙ КРИТИЧНОСТИ (Medium Severity)

### 2.1 Небезопасная Content Security Policy в dev режиме

**Расположение:** `electron/window.ts:16-29`

**Описание:**  
В режиме разработки используется крайне слабая CSP политика, разрешающая `unsafe-inline`, `unsafe-eval` и подключения к любым localhost портам.

```typescript
// electron/window.ts:23
: "default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; connect-src 'self' ws: http://localhost:*;"
```

**Проблемы:**

- `unsafe-eval` позволяет выполнение строк как кода
- `unsafe-inline` открывает возможность для XSS атак
- Широкий разрешенный диапазон для WebSocket и HTTP соединений

**Рекомендации:**

1. Использовать nonce-based CSP даже в dev режиме
2. Ограничить connect-src конкретными портами (например, только 5173 для Vite)
3. Удалить unsafe-eval где возможно

---

### 2.2 Недостаточная валидация входных данных

**Расположение:** `src/types/ipc.ts`, различные IPC handlers

**Описание:**  
Хотя используется Zod для валидации, некоторые поля имеют недостаточные ограничения:

```typescript
// src/types/ipc.ts:47
sd_number: z.string().trim().max(120, 'Номер SD слишком длинный').optional(),
```

**Проблемы:**

- Слишком большая максимальная длина для номера SD (120 символов)
- Отсутствие валидации формата (должны быть только цифры)
- `notes` и `equipment_list` не имеют ограничений по длине
- Отсутствует санитизация HTML спецсимволов

**Рекомендации:**

1. Добавить regex валидацию для форматов
2. Ограничить максимальную длину текстовых полей
3. Санитизировать входные данные от HTML/JS инъекций

```typescript
// Улучшенная валидация
sd_number: z.string()
  .trim()
  .regex(/^\d{3,20}$/, 'Номер SD должен содержать только цифры (3-20 символов)')
  .optional(),

notes: z.string()
  .trim()
  .max(5000, 'Примечания слишком длинные')
  .optional()
  .transform(sanitizeHtml),
```

---

### 2.3 Уязвимость к Path Traversal в backup/restore

**Расположение:** `electron/ipc/backup.ts:47`, `electron/database.ts:375`

**Описание:**  
Функции работы с резервными копиями не валидируют пути к файлам должным образом, что может привести к чтению/записи файлов вне предполагаемой директории.

```typescript
// electron/ipc/backup.ts:46
const backupFilePath = result.filePaths[0]
// Используется напрямую без проверки
await fs.promises.copyFile(backupFilePath, dbPath)
```

**Проблемы:**

- Пользователь может выбрать любой файл для восстановления
- Отсутствует проверка, что файл действительно является SQLite базой данных
- Возможен DoS через восстановление поврежденного файла

**Рекомендации:**

1. Валидировать формат файла перед восстановлением
2. Проверять SQLite magic bytes (SQLite format 3)
3. Тестировать целостность БД перед применением
4. Ограничить размер файла для восстановления

```typescript
async function validateSQLiteFile(filePath: string): Promise<boolean> {
  const buffer = Buffer.alloc(16)
  const fd = await fs.promises.open(filePath, 'r')
  await fd.read(buffer, 0, 16, 0)
  await fd.close()

  const magic = buffer.toString('ascii', 0, 15)
  return magic === 'SQLite format 3'
}
```

---

### 2.4 Отсутствие rate limiting для IPC вызовов

**Расположение:** Все IPC handlers

**Описание:**  
IPC handlers не имеют ограничений на частоту вызовов. Злонамеренный renderer процесс может вызвать DoS атаку, бомбардируя main process запросами.

**Проблемы:**

- Отсутствует throttling/debouncing критических операций
- Нет защиты от спама запросами к БД
- Возможен DoS через массовое создание записей

**Рекомендации:**

1. Добавить rate limiting для IPC вызовов
2. Использовать debounce/throttle для некритических операций
3. Ограничить максимальное количество одновременных операций
4. Добавить проверку на подозрительную активность

---

### 2.5 Небезопасное управление обновлениями (macOS)

**Расположение:** `electron/updater.ts:217-317`

**Описание:**  
Ручной режим обновления для macOS имеет несколько проблем:

- Загрузка обновлений по HTTPS без проверки подписи
- Автоматическое открытие загруженного файла
- Отсутствие верификации целостности файла

```typescript
// electron/updater.ts:294-300
const result = await shell.openPath(targetPath)
if (result) {
  log.warn('Failed to open installer:', result)
} else {
  log.info('Installer opened successfully')
}
```

**Проблемы:**

- Нет проверки цифровой подписи файла
- Нет верификации checksum
- MITM атака может подменить файл обновления
- Автоматическое открытие может быть опасным

**Рекомендации:**

1. Добавить проверку SHA-256 checksum
2. Верифицировать цифровую подпись файла
3. Не открывать файл автоматически, только показывать в Finder
4. Использовать signed updates через GitHub Releases

---

### 2.6 Небезопасная обработка ошибок

**Расположение:** Множество файлов

**Описание:**  
Обработка ошибок часто раскрывает внутреннюю информацию о системе и структуре базы данных.

```typescript
// electron/ipc/requests.ts:174
return { success: false, error: (error as Error).message }
```

**Проблемы:**

- Stack traces могут утекать в renderer процесс
- Сообщения об ошибках БД раскрывают структуру таблиц
- Отсутствует логирование ошибок безопасности

**Рекомендации:**

1. Использовать generic сообщения об ошибках для пользователя
2. Детальные ошибки только в логах
3. Не передавать stack traces в renderer
4. Логировать все ошибки безопасности отдельно

---

### 2.7 Отсутствие защиты от CSRF/SSRF в IPC

**Расположение:** Все IPC handlers

**Описание:**  
Хотя Electron изолирует renderer процесс, компрометированный renderer может выполнять произвольные IPC вызовы.

**Проблемы:**

- Отсутствуют токены для критических операций
- Нет проверки источника IPC вызова
- Все IPC методы доступны из любого контекста

**Рекомендации:**

1. Добавить nonce/token для критических операций (удаление, экспорт)
2. Реализовать подтверждение для опасных действий
3. Проверять контекст вызова IPC handler
4. Использовать contextBridge правильно (уже есть)

---

## 3. УЯЗВИМОСТИ НИЗКОЙ КРИТИЧНОСТИ (Low Severity)

### 3.1 Отсутствие защиты от Clickjacking

**Расположение:** `electron/window.ts`

**Описание:**  
Отсутствует защита от встраивания окна приложения в iframe (хотя это менее критично для desktop приложения).

**Рекомендации:**

- Добавить X-Frame-Options заголовок
- Использовать frame-ancestors в CSP

---

### 3.2 Verbose логирование в production

**Расположение:** Множество файлов с `console.log`, `log.info`

**Описание:**  
Приложение логирует много информации, включая потенциально чувствительные данные.

```typescript
// electron/database.ts:217
console.log('✅ База данных инициализирована')
```

**Рекомендации:**

1. Использовать уровни логирования (debug/info/warn/error)
2. Отключать debug логи в production
3. Не логировать чувствительные данные (пароли, персональные данные)

---

### 3.3 Небезопасные зависимости

**Расположение:** `package.json`

**Описание:**  
Необходима регулярная проверка зависимостей на известные уязвимости.

**Текущие зависимости с потенциальными проблемами:**

- Electron 39.0.0 - проверить наличие CVE
- sqlite3 5.1.7 - проверить наличие обновлений безопасности
- knex 3.1.0 - может иметь уязвимости SQL injection

**Рекомендации:**

1. Настроить автоматическую проверку зависимостей (Dependabot, Snyk)
2. Регулярно обновлять зависимости
3. Использовать `npm audit` перед каждым релизом
4. Подписаться на security advisories для критических пакетов

---

### 3.4 Отсутствие sandboxing для renderer процесса

**Расположение:** `electron/window.ts:44-48`

**Описание:**  
Хотя `nodeIntegration: false` и `contextIsolation: true` настроены правильно, отсутствует полный sandbox.

```typescript
webPreferences: {
  preload: preloadPath,
  nodeIntegration: false,
  contextIsolation: true,
}
```

**Рекомендации:**

1. Добавить `sandbox: true` в webPreferences
2. Включить `contextIsolation` (уже есть)
3. Ограничить разрешения через permissions API

---

### 3.5 Недостаточное логирование событий безопасности

**Расположение:** Весь проект

**Описание:**  
Отсутствует централизованное логирование событий безопасности:

- Попытки доступа к данным
- Операции экспорта
- Изменения критических данных
- Попытки восстановления из backup

**Рекомендации:**

1. Создать audit log систему
2. Логировать все критические операции
3. Хранить логи отдельно от основной БД
4. Защитить логи от изменения

---

### 3.6 Хранение настроек в localStorage

**Расположение:** `src/App.tsx`, `src/hooks/usePersistentState.tsx`

**Описание:**  
UI состояние хранится в localStorage без шифрования. Хотя это не критично, может раскрыть информацию о привычках пользователя.

**Рекомендации:**

1. Использовать IndexedDB для structured data
2. Шифровать чувствительные настройки
3. Регулярно очищать устаревшие данные

---

### 3.7 Отсутствие HTTPS для WebSocket в dev

**Расположение:** `electron/window.ts:23`

**Описание:**  
CSP разрешает незащищенные WebSocket соединения в dev режиме.

**Рекомендации:**

- Даже в dev режиме использовать wss:// где возможно
- Ограничить разрешенные адреса WebSocket

---

### 3.8 Уязвимость к Memory Leaks

**Расположение:** `electron/notifications.ts`, `electron/main.ts`

**Описание:**  
Некоторые подписки и интервалы могут не очищаться должным образом при закрытии приложения.

```typescript
// electron/updater.ts:363-369
setInterval(
  () => {
    void autoUpdater.checkForUpdates()
  },
  4 * 60 * 60 * 1000
)
```

**Рекомендации:**

1. Правильно очищать все setInterval при shutdown
2. Отписываться от всех событий
3. Использовать WeakMap/WeakSet где возможно

---

## 4. ИНФОРМАЦИОННЫЕ ЗАМЕЧАНИЯ

### 4.1 DevTools открыты в dev режиме

**Расположение:** `electron/window.ts:117, 120`

Это нормально для разработки, но убедитесь, что DevTools отключены в production.

---

### 4.2 Auto-start приложения

**Расположение:** `electron/main.ts:67-70`

```typescript
app.setLoginItemSettings({
  openAtLogin: true,
  openAsHidden: false,
})
```

Принудительный автозапуск может быть нежелателен для пользователей. Рекомендуется сделать опциональным.

---

### 4.3 Singleton Lock

**Расположение:** `electron/main.ts:31`

Хорошая практика безопасности - предотвращает запуск нескольких экземпляров.

---

## 5. ПРИОРИТЕТНЫЕ РЕКОМЕНДАЦИИ ПО ИСПРАВЛЕНИЮ

### Немедленно (Critical):

1. **Исправить SQL Injection риски**
   - Использовать только параметризованные запросы
   - Удалить все `whereRaw` с пользовательским вводом
   - Добавить строгую валидацию в поисковые функции

2. **Добавить валидацию URL**
   - Белый список для `shell.openExternal`
   - Строгая валидация номеров SD
   - Запретить опасные протоколы (file://, javascript:)

3. **Исправить Command Injection в updater**
   - Валидировать пути к файлам
   - Использовать path.normalize и проверки

4. **Внедрить аутентификацию**
   - Добавить систему логина/пароля
   - Шифровать базу данных (SQLCipher)

### Краткосрочно (High priority):

5. **Улучшить CSP политику**
6. **Добавить rate limiting для IPC**
7. **Улучшить валидацию входных данных**
8. **Добавить верификацию обновлений**

### Среднесрочно (Medium priority):

9. **Внедрить audit logging**
10. **Улучшить обработку ошибок**
11. **Добавить sandbox для renderer**
12. **Настроить мониторинг зависимостей**

### Долгосрочно (Low priority):

13. **Оптимизировать логирование**
14. **Добавить шифрование настроек**
15. **Улучшить управление памятью**

---

## 6. COMPLIANCE И СТАНДАРТЫ

### GDPR / Персональные данные

Приложение обрабатывает персональные данные (ФИО, логины сотрудников). Необходимо:

- Добавить шифрование персональных данных
- Реализовать право на забвение (удаление данных)
- Добавить согласие на обработку данных
- Документировать процессы обработки данных

### OWASP Top 10 (Desktop Application)

Проект уязвим к следующим категориям OWASP:

- A01:2021 - Broken Access Control (отсутствует аутентификация)
- A02:2021 - Cryptographic Failures (нет шифрования БД)
- A03:2021 - Injection (SQL injection риски)
- A05:2021 - Security Misconfiguration (слабая CSP в dev)
- A07:2021 - Identification and Authentication Failures
- A09:2021 - Security Logging and Monitoring Failures

---

## 7. ИНСТРУМЕНТЫ ДЛЯ ДАЛЬНЕЙШЕГО АНАЛИЗА

Рекомендуется использовать следующие инструменты:

1. **Static Analysis:**
   - ESLint с security плагинами (eslint-plugin-security)
   - SonarQube для комплексного анализа
   - Semgrep для поиска паттернов уязвимостей

2. **Dependency Scanning:**
   - npm audit
   - Snyk
   - GitHub Dependabot

3. **Runtime Analysis:**
   - Electron Security Warnings
   - Chrome DevTools Security Panel

4. **Penetration Testing:**
   - Burp Suite для анализа сетевого трафика
   - OWASP ZAP

---

## 8. ЗАКЛЮЧЕНИЕ

Приложение Equipment Tracker имеет **значительные проблемы безопасности**, которые делают его уязвимым к различным атакам. Основные риски связаны с:

1. **Отсутствием аутентификации** - любой с физическим доступом может просматривать/изменять данные
2. **Незащищенным хранением данных** - БД не зашифрована
3. **SQL Injection рисками** - недостаточная валидация пользовательского ввода
4. **Command Injection** - в процессе обновления macOS
5. **Небезопасной обработкой внешних ресурсов** - URL, файлов обновлений

**Оценка безопасности:** 4/10 (Критические проблемы)

**Рекомендация:** Немедленно исправить критические уязвимости перед использованием в production среде с реальными данными.

---

## 9. ЧЕКЛИСТ ДЛЯ РАЗРАБОТЧИКОВ

### Перед каждым релизом:

- [ ] Проверить все зависимости на уязвимости (`npm audit`)
- [ ] Убедиться, что DevTools отключены в production
- [ ] Проверить CSP политику
- [ ] Протестировать IPC handlers на injection атаки
- [ ] Проверить валидацию всех пользовательских вводов
- [ ] Убедиться, что логи не содержат чувствительных данных
- [ ] Проверить, что все внешние URL валидируются
- [ ] Протестировать процесс обновления на безопасность

### При добавлении нового функционала:

- [ ] Использовать параметризованные SQL запросы
- [ ] Валидировать все входные данные с помощью Zod
- [ ] Не использовать `eval`, `Function`, `innerHTML`
- [ ] Санитизировать пользовательский ввод
- [ ] Логировать критические операции
- [ ] Добавить rate limiting если необходимо
- [ ] Документировать security considerations

---

**Составитель отчета:** GitHub Copilot Security Analysis Agent  
**Контакт:** security@example.com  
**Версия отчета:** 1.0
