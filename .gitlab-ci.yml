workflow:
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
    - when: never

stages:
  - sync

variables:
  GITHUB_OWNER: 'MaRT1n1q'
  GITHUB_REPO: 'Equipment.Tracker'

sync_release:
  stage: sync
  image: alpine:3.20
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      [[ -n "$CI_COMMIT_TAG" ]] || { echo "Tag name is required."; exit 1; }
      [[ -n "$GITHUB_TOKEN" ]] || { echo "Set GITHUB_TOKEN in GitLab CI/CD variables." >&2; exit 1; }
      API_URL="https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/releases/tags/${CI_COMMIT_TAG}"
      echo "Fetching release metadata from ${API_URL}"
      RELEASE_JSON=$(curl -sSf -H "Authorization: token ${GITHUB_TOKEN}" "$API_URL")
      BODY=$(echo "$RELEASE_JSON" | jq -r '.body // ""')
      NAME=$(echo "$RELEASE_JSON" | jq -r --arg fallback "ðŸš€ Equipment Tracker ${CI_COMMIT_TAG}" '.name // $fallback')
      STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --header "JOB-TOKEN: $CI_JOB_TOKEN" "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases/${CI_COMMIT_TAG}")
      if [ "$STATUS_CODE" = "200" ]; then
        METHOD="PUT"
        ENDPOINT="$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases/${CI_COMMIT_TAG}"
        echo "Release exists in GitLab, updating description."
      else
        METHOD="POST"
        ENDPOINT="$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
        echo "Creating new release in GitLab."
      fi
      PAYLOAD=$(jq -n --arg name "$NAME" --arg tag "$CI_COMMIT_TAG" --arg desc "$BODY" '{name:$name, tag_name:$tag, description:$desc}')
      curl --request "$METHOD" \
        --silent --show-error --fail \
        --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "$PAYLOAD" \
        "$ENDPOINT"
      ASSETS_URL=$(echo "$RELEASE_JSON" | jq -r '.assets_url // empty')
      if [ -n "$ASSETS_URL" ]; then
        echo "Syncing asset links from GitHub release."
        curl -sSf -H "Authorization: token ${GITHUB_TOKEN}" "$ASSETS_URL" | jq -c '.[]' | while read -r asset; do
          ASSET_NAME=$(echo "$asset" | jq -r '.name // empty')
          ASSET_URL=$(echo "$asset" | jq -r '.browser_download_url // empty')
          if [ -z "$ASSET_NAME" ] || [ -z "$ASSET_URL" ]; then
            continue
          fi
          LINK_PAYLOAD=$(jq -n --arg name "$ASSET_NAME" --arg url "$ASSET_URL" '{name:$name, url:$url}')
          curl --request POST \
            --silent --show-error \
            --header "JOB-TOKEN: $CI_JOB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "$LINK_PAYLOAD" \
            "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases/${CI_COMMIT_TAG}/assets/links" \
            || echo "Link ${ASSET_NAME} may already exist, skipping."
        done
      fi
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
