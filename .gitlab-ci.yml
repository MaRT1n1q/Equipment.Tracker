stages:
  - lint
  - build
  - release

workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH

default:
  image: node:20-bullseye
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/npm
      - .cache/electron
      - .cache/electron-builder
  variables:
    NPM_CONFIG_CACHE: '$CI_PROJECT_DIR/.cache/npm'
    ELECTRON_CACHE: '$CI_PROJECT_DIR/.cache/electron'
    ELECTRON_BUILDER_CACHE: '$CI_PROJECT_DIR/.cache/electron-builder'
    GIT_STRATEGY: fetch
    GIT_DEPTH: '50'
  before_script:
    - corepack enable
    - npm ci

lint:
  stage: lint
  script:
    - npm run lint
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH
  allow_failure: false

build_web:
  stage: build
  needs:
    - lint
  script:
    - npm run build:ci
  artifacts:
    paths:
      - dist
      - dist-electron
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

.build_release_template:
  stage: release
  variables:
    ELECTRON_BUILDER_DISABLE_UPDATER: 'true'
  artifacts:
    paths:
      - release
    expire_in: 1 week

build_windows_artifacts:
  extends: .build_release_template
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  image: electronuserland/builder:wine
  before_script:
    - npm config set cache "$NPM_CONFIG_CACHE"
    - npm ci
  script:
    - npm run build:win
    - mkdir -p release/windows
    - |
      for pattern in "release"/*.exe "release"/*.exe.blockmap "release"/latest.yml; do
        if [ -e "$pattern" ]; then
          mv "$pattern" release/windows/
        fi
      done
  artifacts:
    paths:
      - release/windows
    expire_in: 1 week

build_linux_artifacts:
  extends: .build_release_template
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends libarchive-tools xz-utils rpm fakeroot g++ make
    - npm ci
  script:
    - npm run build:linux
    - mkdir -p release/linux
    - |
      for pattern in "release"/*.AppImage "release"/*.AppImage.blockmap "release"/*.deb "release"/latest-linux.yml; do
        if [ -e "$pattern" ]; then
          mv "$pattern" release/linux/
        fi
      done
  artifacts:
    paths:
      - release/linux
    expire_in: 1 week

build_macos_artifacts:
  extends: .build_release_template
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  tags:
    - macos
  before_script:
    - npm ci
  script:
    - npm run build:mac
    - mkdir -p release/macos
    - |
      for pattern in "release"/*.dmg "release"/*.dmg.blockmap "release"/*.zip "release"/latest-mac.yml; do
        if [ -e "$pattern" ]; then
          mv "$pattern" release/macos/
        fi
      done
  artifacts:
    paths:
      - release/macos
    expire_in: 1 week
  allow_failure: true

create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build_windows_artifacts
    - job: build_linux_artifacts
    - job: build_macos_artifacts
      optional: true
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  script:
    - apk add --no-cache python3
    - |2
      python3 <<'PY'
      import json
      import os
      import subprocess

      project_url = os.environ["CI_PROJECT_URL"]
      tag = os.environ["CI_COMMIT_TAG"]
      version = tag.lstrip("v")
      release_dir = os.path.join(os.getcwd(), "release")
      assets = []
      if os.path.isdir(release_dir):
        for root, _, files in os.walk(release_dir):
          for filename in files:
            rel_path = os.path.relpath(os.path.join(root, filename)).replace(os.sep, "/")
            parts = rel_path.split("/")
            if len(parts) < 2:
              continue
            group = parts[1]
            job = f"build_{group}_artifacts"
            assets.append(
              {
                "name": filename,
                "url": f"{project_url}/-/jobs/artifacts/{tag}/raw/{rel_path}?job={job}",
                "filepath": f"/{filename}",
                "link_type": "package",
              }
            )

      description = f"""# ðŸš€ Ð ÐµÐ»Ð¸Ð· Equipment Tracker {tag}

      ---

      ## ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°

      ### ðŸªŸ Windows (x64)

      â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº Ð¸ ÑÐ»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼

      ---

      ### ðŸ macOS

      ðŸ“‚ ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ `.dmg` Ð¸ Ð¿ÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð² Ð¿Ð°Ð¿ÐºÑƒ Applications

      ---

      ### ðŸ§ Linux (x64)

      ```bash
      chmod +x Equipment-Tracker-{version}-linux-x64.AppImage
      ./Equipment-Tracker-{version}-linux-x64.AppImage
      ```

      ---

      ## ðŸ”„ ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ

      Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ, Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ñ‚ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ.
      """

      cmd = [
        "release-cli",
        "create",
        "--name",
        f"ðŸš€ Equipment Tracker {tag}",
        "--tag-name",
        tag,
        "--ref",
        os.environ["CI_COMMIT_SHA"],
        "--description",
        description,
      ]

      for asset in assets:
        cmd.extend(["--assets-link", json.dumps(asset, ensure_ascii=False)])

      subprocess.check_call(cmd)
      PY
