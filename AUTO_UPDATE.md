# Система автообновления

Приложение Equipment Tracker поддерживает автоматическое обновление через GitHub Releases.

## Как это работает

1. **Автоматическая проверка**: Приложение проверяет наличие обновлений:
   - При запуске
   - Каждые 4 часа в фоновом режиме

2. **Автоматическая загрузка**: Когда доступно новое обновление:
   - Пользователь получает уведомление
   - Обновление загружается в фоновом режиме
   - Не требует действий от пользователя

3. **Установка**: После загрузки обновления:
   - Пользователь может установить немедленно (с перезапуском)
   - Или отложить установку до следующего запуска приложения

## Публикация новой версии

### Автоматическая публикация (рекомендуется)

Благодаря GitHub Actions, релизы создаются автоматически:

1. **Обновите версию**:

```bash
npm version patch  # для исправлений (1.0.7 -> 1.0.8)
npm version minor  # для новых функций (1.0.7 -> 1.1.0)
npm version major  # для breaking changes (1.0.7 -> 2.0.0)
```

2. **Отправьте изменения и теги**:

```bash
git push
git push --tags
```

3. **Готово!** GitHub Actions автоматически:
   - Соберёт приложение
   - Создаст релиз на GitHub
   - Загрузит все необходимые файлы
   - Пользователи получат уведомление об обновлении

### Ручная публикация (альтернатива)

### Ручная публикация (альтернатива)

Если нужно опубликовать релиз вручную:

#### 1. Соберите приложение

```bash
npm run build:win
```

#### 2. Создайте GitHub Release

##### Вариант A: Через GitHub UI

1. Перейдите на страницу репозитория на GitHub
2. Нажмите "Releases" → "Draft a new release"
3. Создайте новый тег (например, `v1.0.7`)
4. Загрузите файлы из папки `release/`:
   - `Equipment-Tracker-1.0.7-win-x64.exe` (установщик)
   - `latest.yml` (метаданные для автообновления)
   - `Equipment-Tracker-1.0.7-win-x64.exe.blockmap` (опционально, для дифференциального обновления)
5. Опубликуйте релиз

##### Вариант B: Автоматически через electron-builder

```bash
# Установите GitHub token
set GH_TOKEN=ваш_github_token

# Соберите и опубликуйте
npm run build:win -- --publish always
```

### Пользователи получат обновление автоматически

После публикации релиза:

- Все запущенные приложения получат уведомление о доступности обновления
- Обновление загрузится автоматически
- Пользователь сможет установить его по готовности

## Требования

### Для автообновления необходимо:

1. **Публичный или приватный GitHub репозиторий**
2. **GitHub Release с правильными файлами**:
   - Установщик (`.exe` для Windows)
   - Файл `latest.yml` (создается автоматически)

3. **Подписанный код**:
   - Для Windows: сертификат code signing (уменьшает предупреждения SmartScreen)
   - Для macOS: учётная запись Apple Developer, включённый Hardened Runtime и нотарификация (с версии 1.0.13 выполняется автоматически)

### macOS: автоматическая нотарификация

Для того чтобы пользователям не приходилось запускать `xattr -d com.apple.quarantine`, сборка должна быть подписана и отправлена в нотариат Apple. Процесс выполняется автоматически на этапе `afterSign`, если заданы переменные окружения:

- `APPLE_ID` — Apple ID разработчика (email)
- `APPLE_APP_SPECIFIC_PASSWORD` — пароль приложения, созданный на https://appleid.apple.com/
- `APPLE_TEAM_ID` — идентификатор команды (Team ID из Developer Console)
- `APPLE_ASC_PROVIDER` — опционально, если в учетке несколько команд

Дополнительно можно установить `SKIP_NOTARIZE=true` для локальных тестовых сборок, чтобы пропустить нотарификацию.

> ⚠️ Без этих переменных macOS билд будет создан, но останется в карантине и потребует ручной `xattr`. Для публичных релизов обязательно задайте значения.

## Конфигурация

Настройки находятся в:

### package.json

```json
{
  "build": {
    "publish": {
      "provider": "github",
      "owner": "MaRT1n1q",
      "repo": "2"
    }
  }
}
```

### electron/updater.ts

```typescript
autoUpdater.autoDownload = true // Автозагрузка
autoUpdater.autoInstallOnAppQuit = true // Автоустановка при выходе
```

## Логи

Логи автообновления сохраняются в:

- **Windows**: `%USERPROFILE%\AppData\Roaming\Equipment Tracker\logs\`
- **macOS**: `~/Library/Logs/Equipment Tracker/`
- **Linux**: `~/.config/Equipment Tracker/logs/`

## Отладка

Для тестирования автообновления в режиме разработки:

1. Соберите production версию
2. Установите её
3. Создайте новый релиз с увеличенной версией
4. Запустите установленное приложение
5. Оно должно обнаружить и загрузить обновление

## Поддерживаемые платформы

- ✅ Windows (NSIS installer)
- ⚠️ macOS (требуется настройка code signing)
- ⚠️ Linux (требуется дополнительная настройка)

## Безопасность

- Обновления загружаются только через HTTPS
- Проверяется подпись файлов (если настроена)
- Пользователь может отложить установку
- Резервная копия БД создается перед обновлением

## Troubleshooting

### Обновления не находятся

- Проверьте подключение к интернету
- Убедитесь, что релиз опубликован на GitHub
- Проверьте логи в папке приложения

### Ошибка при загрузке

- Проверьте наличие файла `latest.yml` в релизе
- Убедитесь, что версия в релизе выше текущей
- Проверьте права доступа к репозиторию (для приватных)

### Обновление не устанавливается

- Закройте все экземпляры приложения
- Проверьте права администратора (Windows)
- Проверьте логи для деталей ошибки
